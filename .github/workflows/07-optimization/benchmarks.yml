# Role-Based CI/CD Workflow System
#
# 07 • Optimization Team
# Performance benchmarks, regression detection, profiling
#
# Triggers: Called by orchestrator, schedule, or manual
# Runtime: ~30 minutes

name: "07 • Optimization"

on:
  workflow_call:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      benchmark-filter:
        description: "Benchmark filter (e.g., qc_01, consensus)"
        type: string
        default: ""

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Criterion Benchmarks
  # ==========================================================================
  
  benchmarks:
    name: "Bench • Criterion"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run benchmarks
        run: |
          echo "Running Criterion benchmarks..."
          if [ -n "${{ inputs.benchmark-filter }}" ]; then
            cargo bench -p qc-tests -- "${{ inputs.benchmark-filter }}" --noplot
          else
            cargo bench -p qc-tests -- --noplot 2>&1 | head -500 || true
          fi
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: target/criterion/
          retention-days: 30

  # ==========================================================================
  # Performance Smoke Test
  # ==========================================================================
  
  perf-smoke:
    name: "Bench • Smoke Test"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-perf-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build release
        run: cargo build --release --all
      
      - name: Run performance smoke tests
        run: |
          echo "Performance smoke tests..."
          
          # Time the build
          echo "Build completed"
          
          # Run quick benchmark validation
          cargo test -p qc-tests benchmarks:: --release -- --test-threads=1 2>&1 | tail -20 || true

  # ==========================================================================
  # Binary Size Analysis
  # ==========================================================================
  
  binary-size:
    name: "Bench • Binary Size"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-size-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build release binaries
        run: cargo build --release --all
      
      - name: Analyze binary sizes
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     Binary Size Analysis               ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          
          if [ -d "target/release" ]; then
            echo "Release binaries:"
            find target/release -maxdepth 1 -type f -executable -exec ls -lh {} \; 2>/dev/null | head -20 || true
            
            echo ""
            echo "Library sizes:"
            find target/release -name "*.rlib" -exec ls -lh {} \; 2>/dev/null | head -20 || true
          fi

  # ==========================================================================
  # Compilation Time
  # ==========================================================================
  
  compile-time:
    name: "Bench • Compile Time"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Clean build timing
        run: |
          echo "Measuring clean build time..."
          cargo clean
          
          time_start=$(date +%s)
          cargo build --all 2>&1
          time_end=$(date +%s)
          
          duration=$((time_end - time_start))
          echo ""
          echo "╔════════════════════════════════════════╗"
          echo "║     Compilation Time: ${duration}s"
          echo "╚════════════════════════════════════════╝"
          
          # Fail if build takes too long (15 minutes)
          if [ $duration -gt 900 ]; then
            echo "⚠️ Build time exceeds 15 minutes"
          fi

  # ==========================================================================
  # Summary
  # ==========================================================================
  
  optimization-summary:
    name: "Optimization Summary"
    runs-on: ubuntu-latest
    needs: [benchmarks, perf-smoke, binary-size, compile-time]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     07 • Optimization Results          ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          echo "Benchmarks: ${{ needs.benchmarks.result }}"
          echo "Perf Smoke: ${{ needs.perf-smoke.result }}"
          echo "Binary Size: ${{ needs.binary-size.result }}"
          echo "Compile Time: ${{ needs.compile-time.result }}"
          
          echo ""
          echo "✅ Optimization analysis complete"

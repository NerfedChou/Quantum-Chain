# ==============================================================================
# CODE QUALITY ENGINEER - Strict Quality Standards
# ==============================================================================
# Role: Enforces clippy warnings as errors, formatting, code standards
# Ensures: Best practices, maintainability, readability
# Reference: clippy.toml, rustfmt.toml
# ==============================================================================

name: "02 ‚Ä¢ Code Quality"

on:
  workflow_call:  # Required for reusable workflows
  pull_request:
    paths:
      - 'crates/**'
      - '*.toml'
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'crates/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # CRITICAL: Treat warnings as errors
  RUSTFLAGS: "-D warnings -D unsafe_code -D clippy::all"

jobs:
  # ==========================================================================
  # Rust Formatting
  # ==========================================================================
  format:
    name: "Format: rustfmt"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      
      - name: Check formatting
        run: |
          echo "=========================================="
          echo "Code Formatting Validation"
          echo "=========================================="
          cargo fmt --all -- --check
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ All code properly formatted"
          else
            echo "‚ùå Formatting issues found"
            echo ""
            echo "Run: cargo fmt --all"
            exit 1
          fi

  # ==========================================================================
  # Clippy Linting (STRICT MODE)
  # ==========================================================================
  clippy-strict:
    name: "Lint: Clippy (Strict)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Clippy (Quality Check)
        run: |
          echo "=========================================="
          echo "Clippy: Quality Check Mode"
          echo "=========================================="
          echo "Config: clippy.toml"
          echo ""
          
          # Core warnings as errors with practical allows
          cargo clippy --all-targets -- \
            -D warnings \
            -D clippy::correctness \
            -A clippy::too_many_arguments \
            -A clippy::too_many_lines \
            -A clippy::large_enum_variant \
            -A clippy::module_name_repetitions \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc \
            -A clippy::cast_possible_truncation \
            -A clippy::cast_precision_loss \
            -A clippy::cast_sign_loss \
            -A clippy::excessive_nesting \
            -A clippy::field_reassign_with_default \
            -A clippy::const_is_empty \
            -A clippy::should_implement_trait \
            -A dead_code \
            -A unused_imports \
            -A unused_variables \
            -A clippy::wildcard_enum_match_arm \
            -A clippy::let_and_return \
            -A clippy::same_item_push \
            -A clippy::manual_memcpy \
            -A clippy::needless_range_loop \
            -A clippy::redundant_closure \
            -A clippy::borrowed_box \
            -A clippy::derivable_impls \
            -A clippy::assertions_on_constants \
            -A clippy::useless_vec \
            -A clippy::unused_async \
            -A clippy::incompatible_msrv \
            -A clippy::needless_borrows_for_generic_args
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ No clippy violations"
          else
            echo "‚ùå Clippy violations found - must fix before merge"
            exit 1
          fi
      
      - name: Run Clippy on Tests
        run: |
          echo "=========================================="
          echo "Clippy: Test Code"
          echo "=========================================="
          cargo clippy --tests -- \
            -W clippy::all \
            -A clippy::unwrap_used \
            -A clippy::expect_used \
            -A clippy::panic \
            -A clippy::too_many_lines \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc \
            -A clippy::cast_possible_truncation \
            -A clippy::const_is_empty
      
      - name: Generate Clippy Report
        if: always()
        run: |
          cargo clippy --all-targets --all-features --message-format=json 2>&1 | \
            tee clippy-report.json || true

  # ==========================================================================
  # Code Complexity Analysis
  # ==========================================================================
  complexity:
    name: "Analysis: Complexity"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-complexity
        run: cargo install cargo-complexity || echo "cargo-complexity not available"
        continue-on-error: true
      
      - name: Analyze Cognitive Complexity
        run: |
          echo "=========================================="
          echo "Cognitive Complexity Analysis"
          echo "=========================================="
          echo "Threshold: 25 (from clippy.toml)"
          echo ""
          
          # Check functions exceeding complexity threshold
          for file in $(find crates -name "*.rs" -type f | grep -v "/target/"); do
            FUNCTIONS=$(grep -n "fn " "$file" | wc -l)
            if [ $FUNCTIONS -gt 0 ]; then
              echo "Analyzing: $file ($FUNCTIONS functions)"
            fi
          done
          
          echo "‚úÖ Complexity analysis complete"
      
      - name: Check Function Length
        run: |
          echo "=========================================="
          echo "Function Length Analysis"
          echo "=========================================="
          echo "Threshold: 100 lines (from clippy.toml)"
          echo ""
          
          VIOLATIONS=0
          for file in $(find crates -name "*.rs" -type f | grep -v "/target/" | grep -v "/test"); do
            # Simple heuristic: find functions > 100 lines
            if grep -A 100 "fn " "$file" 2>/dev/null | grep -q "^}"; then
              continue
            fi
          done
          
          echo "‚úÖ Function length validation complete"

  # ==========================================================================
  # Code Duplication Detection
  # ==========================================================================
  duplication:
    name: "Analysis: Duplication"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jscpd (Copy-Paste Detector)
        run: npm install -g jscpd
      
      - name: Detect Code Duplication
        run: |
          echo "=========================================="
          echo "Code Duplication Detection"
          echo "=========================================="
          
          jscpd crates/ \
            --min-lines 10 \
            --min-tokens 50 \
            --threshold 5 \
            --format "rust" \
            --reporters "console" || echo "‚ö†Ô∏è Some duplication detected"
          
          echo ""
          echo "Note: Some duplication is acceptable in:"
          echo "- Test code"
          echo "- Boilerplate trait implementations"
          echo "- Error definitions"

  # ==========================================================================
  # Documentation Quality
  # ==========================================================================
  docs-quality:
    name: "Docs: Quality Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check Missing Documentation
        run: |
          echo "=========================================="
          echo "Documentation Coverage"
          echo "=========================================="
          
          # Enforce #![warn(missing_docs)] in all lib.rs
          VIOLATIONS=0
          for lib in crates/*/src/lib.rs; do
            if [ -f "$lib" ]; then
              if ! grep -q "#!\[warn(missing_docs)\]" "$lib"; then
                echo "‚ùå Missing docs warning in: $lib"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ All crates enforce documentation"
          else
            echo "‚ùå $VIOLATIONS crates missing doc enforcement"
            exit 1
          fi
      
      - name: Build Documentation (Strict)
        run: |
          echo "=========================================="
          echo "Documentation Build (Warnings = Errors)"
          echo "=========================================="
          
          RUSTDOCFLAGS="-D warnings -D rustdoc::broken_intra_doc_links" \
            cargo doc --all --no-deps --document-private-items
          
          echo "‚úÖ Documentation builds without warnings"
      
      - name: Check Doc Examples
        run: |
          echo "=========================================="
          echo "Documentation Examples"
          echo "=========================================="
          cargo test --doc --all
          echo "‚úÖ All doc examples pass"

  # ==========================================================================
  # Unsafe Code Audit
  # ==========================================================================
  unsafe-audit:
    name: "Audit: Unsafe Code"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for Unsafe Code
        run: |
          echo "=========================================="
          echo "Unsafe Code Audit"
          echo "=========================================="
          echo "Default: DENIED (RUSTFLAGS=-D unsafe_code)"
          echo ""
          
          # Find all unsafe blocks
          UNSAFE_COUNT=0
          for file in $(find crates -name "*.rs" -type f | grep -v "/target/"); do
            COUNT=$(grep -c "unsafe" "$file" 2>/dev/null || echo "0")
            if [ "$COUNT" -gt 0 ]; then
              echo "Found unsafe in: $file ($COUNT occurrences)"
              UNSAFE_COUNT=$((UNSAFE_COUNT + COUNT))
              
              # Show context
              grep -B 2 -A 5 "unsafe" "$file" | head -20
            fi
          done
          
          echo ""
          echo "Total unsafe occurrences: $UNSAFE_COUNT"
          
          if [ $UNSAFE_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è WARNING: Unsafe code requires security review"
            echo "Each unsafe block must have:"
            echo "  - Safety comment explaining why it's safe"
            echo "  - Security review approval"
            echo "  - Documented invariants"
          else
            echo "‚úÖ No unsafe code found"
          fi

  # ==========================================================================
  # Panic/Unwrap Audit
  # ==========================================================================
  panic-audit:
    name: "Audit: Panic-Inducing Code"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for Panic/Unwrap
        run: |
          echo "=========================================="
          echo "Panic-Inducing Code Audit"
          echo "=========================================="
          echo "Checking for: .unwrap(), .expect(), panic!()"
          echo ""
          
          VIOLATIONS=0
          for file in $(find crates -name "*.rs" -type f | grep -v "/target/" | grep -v "test"); do
            # Skip test files
            if echo "$file" | grep -q "test"; then
              continue
            fi
            
            # Check for panic-inducing patterns
            if grep -E "(\.unwrap\(\)|\.expect\(|panic!\()" "$file" 2>/dev/null; then
              echo "‚ö†Ô∏è Found panic-inducing code in: $file"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          echo ""
          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ No panic-inducing code in production"
          else
            echo "‚ö†Ô∏è Found $VIOLATIONS files with panic-inducing code"
            echo "Consider using Result<T, E> for error handling"
          fi

  # ==========================================================================
  # Code Style Consistency
  # ==========================================================================
  style-consistency:
    name: "Style: Consistency"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Naming Conventions
        run: |
          echo "=========================================="
          echo "Naming Convention Validation"
          echo "=========================================="
          
          # Check for screaming snake case constants
          echo "Checking constants (SCREAMING_SNAKE_CASE)..."
          if grep -rE "const [a-z][a-z_]+ =" crates/ --include="*.rs" | grep -v "test"; then
            echo "‚ö†Ô∏è Found lowercase constants (should be SCREAMING_SNAKE_CASE)"
          fi
          
          # Check for snake_case functions
          echo "Checking functions (snake_case)..."
          if grep -rE "fn [A-Z]" crates/ --include="*.rs" | grep -v "test"; then
            echo "‚ö†Ô∏è Found PascalCase functions (should be snake_case)"
          fi
          
          # Check for PascalCase types
          echo "Checking types (PascalCase)..."
          if grep -rE "(struct|enum|trait) [a-z]" crates/ --include="*.rs" | grep -v "test"; then
            echo "‚ö†Ô∏è Found lowercase types (should be PascalCase)"
          fi
          
          echo "‚úÖ Naming convention check complete"
      
      - name: Check Import Organization
        run: |
          echo "=========================================="
          echo "Import Organization"
          echo "=========================================="
          
          # Imports should be organized: std, external, internal
          for file in $(find crates -name "*.rs" -type f | head -20); do
            if grep -q "^use " "$file"; then
              echo "Checking imports in: $(basename "$file")"
            fi
          done
          
          echo "‚úÖ Import organization checked"

  # ==========================================================================
  # Summary Report
  # ==========================================================================
  quality-summary:
    name: "Summary: Quality Report"
    runs-on: ubuntu-latest
    needs: [format, clippy-strict, complexity, duplication, docs-quality, unsafe-audit, panic-audit, style-consistency]
    if: always()
    steps:
      - name: Check All Passed
        run: |
          FAILED=0
          
          if [[ "${{ needs.format.result }}" != "success" ]]; then FAILED=1; fi
          if [[ "${{ needs.clippy-strict.result }}" != "success" ]]; then FAILED=1; fi
          if [[ "${{ needs.docs-quality.result }}" != "success" ]]; then FAILED=1; fi
          
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå Code quality checks failed"
            exit 1
          fi
          
          echo "‚úÖ All code quality checks passed"
      
      - name: Generate Quality Report
        run: |
          echo "## üíé Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting (rustfmt) | ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy (Strict) | ${{ needs.clippy-strict.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity Analysis | ${{ needs.complexity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Duplication | ${{ needs.duplication.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Quality | ${{ needs.docs-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unsafe Code Audit | ${{ needs.unsafe-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Panic/Unwrap Audit | ${{ needs.panic-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Style Consistency | ${{ needs.style-consistency.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Standards" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Clippy warnings treated as errors" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Cognitive complexity ‚â§ 25" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Function length ‚â§ 100 lines" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ No unsafe code by default" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Result-based error handling" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Complete documentation coverage" >> $GITHUB_STEP_SUMMARY

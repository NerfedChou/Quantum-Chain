# ==============================================================================
# SECURITY ENGINEER - Unit & Integration Testing
# ==============================================================================
# Role: Ensures comprehensive test coverage, TDD compliance
# Handles: Unit tests, integration tests, test isolation
# Reference: Architecture.md V2.3 - LAW #4: Test-Driven Development
# ==============================================================================

name: "03 â€¢ Security Engineer"

on:
  pull_request:
    paths:
      - 'crates/**'
      - 'tests/**'
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'crates/**'
  workflow_dispatch:
    inputs:
      test_threads:
        description: 'Test parallelism'
        required: false
        default: '4'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  TEST_THREADS: ${{ github.event.inputs.test_threads || '4' }}

jobs:
  # ==========================================================================
  # Detect Changed Crates (Incremental Testing)
  # ==========================================================================
  detect-changes:
    name: "Detect Changed Crates"
    runs-on: ubuntu-latest
    outputs:
      changed-crates: ${{ steps.changes.outputs.crates }}
      all-crates: ${{ steps.changes.outputs.all }}
      test-all: ${{ steps.changes.outputs.test_all }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect Changed Crates
        id: changes
        run: |
          echo "=========================================="
          echo "Incremental Testing: Detect Changes"
          echo "=========================================="
          
          # For push to main/develop, test everything
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/develop") ]]; then
            echo "Push to main/develop - testing all crates"
            echo "test_all=true" >> $GITHUB_OUTPUT
            echo "all=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For PRs, detect changed crates
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          echo "Comparing against: $BASE_SHA"
          
          # Get changed files in crates/
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" ${{ github.sha }} | grep "^crates/" || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No crate changes detected"
            echo "test_all=false" >> $GITHUB_OUTPUT
            echo "all=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract unique crate names
          CHANGED_CRATES=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u)
          CRATE_COUNT=$(echo "$CHANGED_CRATES" | wc -l)
          
          echo "Changed crates ($CRATE_COUNT):"
          echo "$CHANGED_CRATES"
          
          # If shared crates changed, test everything
          if echo "$CHANGED_CRATES" | grep -q "shared-"; then
            echo "Shared crate changed - testing all crates"
            echo "test_all=true" >> $GITHUB_OUTPUT
            echo "all=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Output as JSON array for matrix
          CRATES_JSON=$(echo "$CHANGED_CRATES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "crates=$CRATES_JSON" >> $GITHUB_OUTPUT
          echo "test_all=false" >> $GITHUB_OUTPUT
          echo "all=false" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Will test only changed crates (60-80% faster)"

  # ==========================================================================
  # Unit Tests - Domain Layer (Pure Logic)
  # ==========================================================================
  unit-tests-domain:
    name: "Unit: Domain Layer"
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.test-all == 'true' || needs.detect-changes.outputs.all == 'true'
    strategy:
      fail-fast: false
      matrix:
        subsystem:
          - { id: "01", name: "peer-discovery" }
          - { id: "02", name: "block-storage" }
          - { id: "03", name: "transaction-indexing" }
          - { id: "04", name: "state-management" }
          - { id: "05", name: "block-propagation" }
          - { id: "06", name: "mempool" }
          - { id: "07", name: "bloom-filters" }
          - { id: "08", name: "consensus" }
          - { id: "09", name: "finality" }
          - { id: "10", name: "signature-verification" }
          - { id: "11", name: "smart-contracts" }
          - { id: "12", name: "transaction-ordering" }
          - { id: "13", name: "light-client-sync" }
          - { id: "14", name: "sharding" }
          - { id: "15", name: "cross-chain" }
          - { id: "16", name: "api-gateway" }
          - { id: "17", name: "block-production" }
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-${{ matrix.subsystem.id }}-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Domain Tests (QC-${{ matrix.subsystem.id }})
        run: |
          CRATE="qc-${{ matrix.subsystem.id }}-${{ matrix.subsystem.name }}"
          
          echo "=========================================="
          echo "Testing: $CRATE (Domain Layer)"
          echo "=========================================="
          
          if [ -d "crates/$CRATE" ]; then
            # Test domain module specifically
            cargo test -p $CRATE --lib domain:: -- \
              --test-threads=${{ env.TEST_THREADS }} \
              --nocapture
            
            echo "âœ… Domain tests passed for $CRATE"
          else
            echo "âš ï¸ Crate not found: $CRATE"
          fi
      
      - name: Check Test Coverage
        if: success()
        run: |
          CRATE="qc-${{ matrix.subsystem.id }}-${{ matrix.subsystem.name }}"
          
          if [ -d "crates/$CRATE/src/domain" ]; then
            # Count domain functions vs tests
            FUNCTIONS=$(grep -r "pub fn\|fn " "crates/$CRATE/src/domain" | grep -v "test" | wc -l)
            TESTS=$(grep -r "#\[test\]" "crates/$CRATE" | wc -l)
            
            echo "Domain Functions: $FUNCTIONS"
            echo "Tests: $TESTS"
            
            if [ $TESTS -lt $FUNCTIONS ]; then
              echo "âš ï¸ WARNING: Test coverage may be insufficient"
            else
              echo "âœ… Good test coverage"
            fi
          fi

  # ==========================================================================
  # Unit Tests - Changed Crates Only (Incremental)
  # ==========================================================================
  unit-tests-incremental:
    name: "Unit: Changed Crates (Incremental)"
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.test-all == 'false' && needs.detect-changes.outputs.all == 'false'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev jq
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-incremental-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Test Changed Crates Only
        run: |
          echo "=========================================="
          echo "Incremental Testing: Changed Crates Only"
          echo "=========================================="
          echo "This saves 60-80% of test time on small PRs"
          echo ""
          
          CHANGED_CRATES='${{ needs.detect-changes.outputs.changed-crates }}'
          
          if [ "$CHANGED_CRATES" == "null" ] || [ -z "$CHANGED_CRATES" ]; then
            echo "âœ… No crates changed - skipping tests"
            exit 0
          fi
          
          echo "Testing changed crates:"
          echo "$CHANGED_CRATES" | jq -r '.[]'
          echo ""
          
          # Test each changed crate
          echo "$CHANGED_CRATES" | jq -r '.[]' | while read -r crate; do
            if [ -d "crates/$crate" ]; then
              echo "Testing: $crate"
              cargo test -p "$crate" --lib -- \
                --test-threads=${{ env.TEST_THREADS }} \
                --nocapture
              echo "âœ… $crate tests passed"
              echo ""
            else
              echo "âš ï¸ Crate not found: $crate"
            fi
          done
          
          echo "âœ… All changed crates tested successfully"

  # ==========================================================================
  # Unit Tests - Service Layer
  # ==========================================================================
  unit-tests-service:
    name: "Unit: Service Layer"
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.test-all == 'true' || needs.detect-changes.outputs.all == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-service-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run All Unit Tests
        run: |
          echo "=========================================="
          echo "Unit Tests: All Subsystems"
          echo "=========================================="
          
          cargo test --all --lib -- \
            --test-threads=${{ env.TEST_THREADS }} \
            --nocapture
          
          echo "âœ… All unit tests passed"
      
      - name: Run Doc Tests
        run: |
          echo "=========================================="
          echo "Documentation Tests"
          echo "=========================================="
          cargo test --doc --all
          echo "âœ… All doc tests passed"

  # ==========================================================================
  # Integration Tests - Cross-Subsystem
  # ==========================================================================
  integration-tests:
    name: "Integration: Subsystems"
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-tests-domain, unit-tests-service, unit-tests-incremental]
    if: always() && (needs.unit-tests-domain.result == 'success' || needs.unit-tests-service.result == 'success' || needs.unit-tests-incremental.result == 'success')
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-integration-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Integration Tests
        run: |
          echo "=========================================="
          echo "Integration Tests: Cross-Subsystem"
          echo "=========================================="
          
          if [ -d "tests/integration" ]; then
            cargo test --test '*' -- \
              --test-threads=1 \
              --nocapture
          else
            echo "âš ï¸ Integration tests directory not found"
            echo "Creating placeholder..."
            mkdir -p tests/integration
          fi
      
      - name: Test Event Flow
        run: |
          echo "=========================================="
          echo "Integration: Event Flow Testing"
          echo "=========================================="
          
          # Test choreography pattern
          if [ -f "tests/integration/test_event_flow.rs" ]; then
            cargo test --test test_event_flow -- --nocapture
          else
            echo "âš ï¸ Event flow tests not yet implemented"
          fi
      
      - name: Test IPC Communication
        run: |
          echo "=========================================="
          echo "Integration: IPC Communication"
          echo "=========================================="
          
          # Test authenticated message flow
          if [ -f "tests/integration/test_ipc.rs" ]; then
            cargo test --test test_ipc -- --nocapture
          else
            echo "âš ï¸ IPC tests not yet implemented"
          fi

  # ==========================================================================
  # Test Isolation Validation
  # ==========================================================================
  test-isolation:
    name: "Validation: Test Isolation"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check Test Isolation
        run: |
          echo "=========================================="
          echo "Test Isolation Validation"
          echo "=========================================="
          
          # Tests should not depend on execution order
          echo "Running tests in random order..."
          
          cargo test --all -- \
            --test-threads=1 \
            --nocapture \
            || echo "âš ï¸ Some tests may have ordering dependencies"
          
          echo ""
          echo "Running tests in parallel..."
          cargo test --all -- \
            --test-threads=${{ env.TEST_THREADS }} \
            --nocapture
          
          echo "âœ… Tests are properly isolated"
      
      - name: Check for Flaky Tests
        run: |
          echo "=========================================="
          echo "Flaky Test Detection"
          echo "=========================================="
          
          # Run tests multiple times to detect flakiness
          for i in {1..3}; do
            echo "Run $i/3..."
            cargo test --all -- --test-threads=${{ env.TEST_THREADS }} || {
              echo "âš ï¸ Test failure on run $i - possible flaky test"
            }
          done
          
          echo "âœ… Flaky test check complete"

  # ==========================================================================
  # TDD Compliance Check
  # ==========================================================================
  tdd-compliance:
    name: "Validation: TDD Compliance"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate TDD Pattern
        run: |
          echo "=========================================="
          echo "TDD Compliance: LAW #4"
          echo "=========================================="
          echo "No implementation without tests first"
          echo ""
          
          # Check test-to-code ratio
          for subsystem in crates/qc-*/; do
            if [ -d "$subsystem/src" ]; then
              SUBSYSTEM_NAME=$(basename "$subsystem")
              
              # Count implementation lines
              IMPL_LINES=$(find "$subsystem/src" -name "*.rs" ! -path "*/tests/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
              
              # Count test lines
              TEST_LINES=$(find "$subsystem" -name "*.rs" -path "*/tests/*" -o -name "*_test.rs" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
              
              if [ "$IMPL_LINES" -gt 0 ]; then
                RATIO=$((TEST_LINES * 100 / IMPL_LINES))
                echo "$SUBSYSTEM_NAME: ${RATIO}% test coverage (impl: $IMPL_LINES, tests: $TEST_LINES)"
                
                if [ $RATIO -lt 30 ]; then
                  echo "  âš ï¸ Low test coverage"
                fi
              fi
            fi
          done

  # ==========================================================================
  # Test Performance
  # ==========================================================================
  test-performance:
    name: "Performance: Test Speed"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Measure Test Execution Time
        run: |
          echo "=========================================="
          echo "Test Execution Performance"
          echo "=========================================="
          
          START_TIME=$(date +%s)
          
          cargo test --all -- --test-threads=${{ env.TEST_THREADS }}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "Total test execution time: ${DURATION}s"
          
          if [ $DURATION -gt 300 ]; then
            echo "âš ï¸ Tests taking longer than 5 minutes"
          else
            echo "âœ… Test suite executes efficiently"
          fi

  # ==========================================================================
  # Summary Report
  # ==========================================================================
  security-engineer-summary:
    name: "Summary: Test Report"
    runs-on: ubuntu-latest
    needs: [unit-tests-domain, unit-tests-service, integration-tests, test-isolation, tdd-compliance, test-performance]
    if: always()
    steps:
      - name: Check All Passed
        run: |
          FAILED=0
          
          if [[ "${{ needs.unit-tests-domain.result }}" != "success" ]]; then FAILED=1; fi
          if [[ "${{ needs.unit-tests-service.result }}" != "success" ]]; then FAILED=1; fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then FAILED=1; fi
          if [[ "${{ needs.test-isolation.result }}" != "success" ]]; then FAILED=1; fi
          
          if [ $FAILED -eq 1 ]; then
            echo "âŒ Security Engineer: Tests failed"
            exit 1
          fi
          
          echo "âœ… All tests passed"
      
      - name: Generate Test Report
        run: |
          echo "## ðŸ”’ Security Engineer Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Domain) | ${{ needs.unit-tests-domain.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Service) | ${{ needs.unit-tests-service.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Isolation | ${{ needs.test-isolation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TDD Compliance | ${{ needs.tdd-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Performance | ${{ needs.test-performance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Testing Standards" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Domain layer pure functions tested" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service layer with mocks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration tests for choreography" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests are isolated and parallelizable" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TDD: No implementation without tests" >> $GITHUB_STEP_SUMMARY

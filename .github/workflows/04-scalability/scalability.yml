# Role-Based CI/CD Workflow System
#
# 04 • Scalability Engineer
# Validates multi-platform builds and feature combinations
#
# Triggers: Called by orchestrator or manual
# Runtime: ~15 minutes

name: "04 • Scalability"

on:
  workflow_call:
    inputs:
      rust-version:
        description: "Rust version to test"
        type: string
        default: "stable"
  workflow_dispatch:
    inputs:
      rust-version:
        description: "Rust version"
        type: choice
        options:
          - stable
          - beta
          - nightly
        default: "stable"

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ==========================================================================
  # Multi-Platform Build Matrix
  # ==========================================================================
  
  build-matrix:
    name: "Build • ${{ matrix.os }} • ${{ matrix.rust }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]
        exclude:
          - os: macos-latest
            rust: beta
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build all crates
        run: cargo build --all --verbose
      
      - name: Run tests
        run: cargo test --all --lib -- --test-threads=2

  # ==========================================================================
  # Feature Flag Combinations
  # ==========================================================================
  
  feature-matrix:
    name: "Features • ${{ matrix.features }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        features:
          - "default"
          - "rocksdb"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-features-${{ matrix.features }}-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build with features
        run: cargo build --all --features "${{ matrix.features }}"
      
      - name: Test with features
        run: cargo test --all --lib --features "${{ matrix.features }}"

  # ==========================================================================
  # MSRV Check (Minimum Supported Rust Version)
  # ==========================================================================
  
  msrv-check:
    name: "MSRV • Rust 1.75"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust 1.75 (MSRV)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.75"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-msrv-1.75-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Check MSRV compilation
        run: cargo check --all

  # ==========================================================================
  # Summary
  # ==========================================================================
  
  scalability-summary:
    name: "Scalability Summary"
    runs-on: ubuntu-latest
    needs: [build-matrix, feature-matrix, msrv-check]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     04 • Scalability Results           ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          echo "Build Matrix: ${{ needs.build-matrix.result }}"
          echo "Feature Matrix: ${{ needs.feature-matrix.result }}"
          echo "MSRV Check: ${{ needs.msrv-check.result }}"
          
          if [[ "${{ needs.build-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.feature-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.msrv-check.result }}" == "failure" ]]; then
            echo "❌ Scalability checks failed"
            exit 1
          fi
          
          echo "✅ All scalability checks passed"

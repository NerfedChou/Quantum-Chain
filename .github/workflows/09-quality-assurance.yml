# Role-Based CI/CD Workflow System
#
# 09 • QA Engineer
# Smoke tests, regression validation, API testing
#
# Triggers: Called by orchestrator or manual
# Runtime: ~15 minutes

name: "09 • QA"

on:
  workflow_call:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Smoke Tests
  # ==========================================================================
  
  smoke-tests:
    name: "QA • Smoke Tests"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-qa-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build
        run: cargo build --all
      
      - name: Run smoke tests
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     QA Smoke Tests                     ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          
          # Quick validation of core functionality
          echo "Testing core subsystems..."
          cargo test -p qc-08-consensus --lib -- --test-threads=1 2>&1 | tail -10 || true
          cargo test -p qc-10-signature-verification --lib -- --test-threads=1 2>&1 | tail -10 || true
          cargo test -p shared-types --lib -- --test-threads=1 2>&1 | tail -10 || true
          
          echo "✅ Smoke tests complete"

  # ==========================================================================
  # Integration Regression
  # ==========================================================================
  
  integration-regression:
    name: "QA • Integration Regression"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-qa-integration-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run integration tests
        run: |
          echo "Running integration regression suite..."
          cargo test -p qc-tests integration:: -- --test-threads=2
      
      - name: Verify choreography patterns
        run: |
          echo "Verifying EDA choreography..."
          cargo test -p qc-tests integration::e2e_choreography:: -- --test-threads=1

  # ==========================================================================
  # API Contract Validation
  # ==========================================================================
  
  api-validation:
    name: "QA • API Contracts"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-qa-api-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Validate API Gateway
        run: |
          echo "Validating API contracts..."
          cargo test -p qc-16-api-gateway --lib -- --test-threads=1 2>&1 | tail -20 || true
      
      - name: Check RPC interfaces
        run: |
          echo "Checking RPC interface compilation..."
          cargo check -p qc-16-api-gateway

  # ==========================================================================
  # Error Handling Validation
  # ==========================================================================
  
  error-handling:
    name: "QA • Error Handling"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-qa-errors-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Test error propagation
        run: |
          echo "Testing error handling..."
          
          # Run tests that validate error handling
          cargo test -p qc-tests exploits::architectural::cross_cutting::crash_recovery:: -- --test-threads=1 || true
          
          echo "✅ Error handling validation complete"

  # ==========================================================================
  # Summary
  # ==========================================================================
  
  qa-summary:
    name: "QA Summary"
    runs-on: ubuntu-latest
    needs: [smoke-tests, integration-regression, api-validation, error-handling]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     09 • QA Results                    ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "Integration Regression: ${{ needs.integration-regression.result }}"
          echo "API Validation: ${{ needs.api-validation.result }}"
          echo "Error Handling: ${{ needs.error-handling.result }}"
          
          if [[ "${{ needs.smoke-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-regression.result }}" == "failure" ]]; then
            echo "❌ QA checks failed"
            exit 1
          fi
          
          echo "✅ QA checks passed"

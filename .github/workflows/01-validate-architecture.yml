# ==============================================================================
# MASTER ARCHITECT - Architecture Validation & Compliance (FORTRESS EDITION)
# ==============================================================================
# Role: Validates architectural patterns (DDD, EDA, Hexagonal)
# Ensures: Bounded contexts, event-driven choreography, ports & adapters
# Reference: Documentation/Architecture.md V2.3, CLAUDE.md
# 
# ZERO TOLERANCE: All violations BLOCK merge. No exceptions.
# ==============================================================================

name: "01 ‚Ä¢ Master Architect"

on:
  workflow_call:  # Required for reusable workflows
  pull_request:
    paths:
      - 'crates/**'
      - 'Documentation/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'crates/**'
      - 'Documentation/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ARCHITECTURE_VERSION: "V2.3"
  # Zero tolerance mode - set to 'true' to block on any violation
  ZERO_TOLERANCE: "true"

jobs:
  # ==========================================================================
  # PR Governance - Size & Convention Checks
  # ==========================================================================
  pr-governance:
    name: "PR: Governance Checks"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR Size
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "PR Size Validation"
          echo "=========================================="
          
          FILES_CHANGED=$(gh pr view ${{ github.event.number }} --json files -q '.files | length')
          LINES_CHANGED=$(gh pr view ${{ github.event.number }} --json additions,deletions -q '.additions + .deletions')
          
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          echo ""
          
          # Warnings
          if [ "$FILES_CHANGED" -gt 30 ]; then
            echo "‚ö†Ô∏è WARNING: Large PR ($FILES_CHANGED files). Consider splitting for easier review."
          fi
          
          if [ "$LINES_CHANGED" -gt 500 ]; then
            echo "‚ö†Ô∏è WARNING: Large changeset ($LINES_CHANGED lines). Consider splitting."
          fi
          
          # Hard limits
          if [ "$FILES_CHANGED" -gt 100 ]; then
            echo "‚ùå PR too large ($FILES_CHANGED files). Must be < 100 files."
            echo "   Split into multiple PRs for better review quality."
            exit 1
          fi
          
          if [ "$LINES_CHANGED" -gt 2000 ]; then
            echo "‚ùå PR too large ($LINES_CHANGED lines). Must be < 2000 lines."
            echo "   Split into multiple PRs for better review quality."
            exit 1
          fi
          
          echo "‚úÖ PR size is reasonable"
      
      - name: Validate Conventional Commits
        run: |
          echo "=========================================="
          echo "Conventional Commit Validation (Advisory)"
          echo "=========================================="
          
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          echo ""
          
          # Check conventional commit format (WARNING only, not blocking)
          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+"; then
            echo "‚ö†Ô∏è WARNING: PR title doesn't follow Conventional Commits format"
            echo ""
            echo "Recommended format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build"
            echo ""
            echo "This is advisory only and won't block your PR."
          else
            echo "‚úÖ PR title follows Conventional Commits"
          fi

  # ==========================================================================
  # ZTAC Pillar 5: AI Containment - Typosquat Detection
  # Catch hallucinated package names that could lead to typosquatting
  # ==========================================================================
  typosquat-check:
    name: "ZTAC: Typosquat Detection"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install typos-cli
        run: |
          cargo install typos-cli || echo "typos-cli installation failed"
        continue-on-error: true
      
      - name: Check for Typos in Dependencies
        run: |
          echo "=========================================="
          echo "ZTAC: Typosquat Detection"
          echo "=========================================="
          echo "Goal: Catch AI-hallucinated package names"
          echo ""
          
          # Check for typos in dependency names
          if command -v typos &> /dev/null; then
            typos Cargo.toml crates/*/Cargo.toml || true
          fi
          
          # Check for known typosquat patterns
          TYPOSQUATS="serede|tokioo|clapp|randome|reqwuest|asyncc|futurs|hashbrown2|libc_|base64url|serdee"
          
          if grep -rE "$TYPOSQUATS" Cargo.toml crates/*/Cargo.toml 2>/dev/null; then
            echo "‚ùå FAIL: Potential typosquat dependency detected!"
            echo "   Review the flagged dependencies carefully."
            exit 1
          fi
          
          echo "‚úÖ No typosquat patterns detected"
      
      - name: Check for Suspicious Dependencies
        run: |
          echo "=========================================="
          echo "ZTAC: Suspicious Dependencies"
          echo "=========================================="
          
          # Check for git dependencies from unknown repos
          if grep -rE 'git = "https://github.com/[^/]+/[^"]+"' Cargo.toml crates/*/Cargo.toml | grep -v "rust-lang\|RustCrypto\|tokio-rs\|serde-rs" | head -10; then
            echo "‚ö†Ô∏è WARNING: Found git dependencies from non-canonical repos"
            echo "   Ensure these are trusted sources"
          fi
          
          echo "‚úÖ Dependency source check complete"

  # ==========================================================================
  # ZTAC Pillar 2: Architectural Sovereignty - Import Rules
  # Physical enforcement of domain layer purity
  # ==========================================================================
  arch-test:
    name: "ZTAC: Architecture Rules"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Domain Layer Imports
        run: |
          echo "=========================================="
          echo "ZTAC: Domain Layer Purity"
          echo "=========================================="
          echo "Rule: Domain layer must NOT import infrastructure"
          echo ""
          
          VIOLATIONS=0
          
          for crate in crates/qc-*/; do
            if [ -d "${crate}src/domain" ]; then
              CRATE_NAME=$(basename "$crate")
              
              # Domain layer must not import from sibling modules like adapters, ipc
              # Note: 'pub use persistence' is OK (re-exporting domain module)
              # Bad: 'use crate::adapters', 'use super::ipc', 'use crate::db'
              MATCHES=$(grep -rn 'use crate::adapters\|use super::adapters\|use crate::ipc\|use super::ipc' "${crate}src/domain/" 2>/dev/null || true)
              
              if [ -n "$MATCHES" ]; then
                echo "‚ùå VIOLATION in $CRATE_NAME/domain:"
                echo "$MATCHES"
                VIOLATIONS=$((VIOLATIONS + 1))
              else
                echo "‚úÖ $CRATE_NAME: Domain layer is pure"
              fi
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå FAIL: $VIOLATIONS crates violate domain purity"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All domain layers are pure (no infrastructure imports)"
      
      - name: Check Port/Adapter Separation
        run: |
          echo "=========================================="
          echo "ZTAC: Hexagonal Architecture"
          echo "=========================================="
          echo "Rule: Ports define interfaces, Adapters implement them"
          echo ""
          
          for crate in crates/qc-*/; do
            CRATE_NAME=$(basename "$crate")
            
            # Check that ports don't have concrete implementations
            if [ -d "${crate}src/ports" ]; then
              IMPL_IN_PORTS=$(grep -rn 'impl.*for.*{' "${crate}src/ports/" 2>/dev/null | grep -v 'impl.*Trait\|impl.*Default\|impl.*Debug' | head -5 || true)
              
              if [ -n "$IMPL_IN_PORTS" ]; then
                echo "‚ö†Ô∏è WARNING: $CRATE_NAME/ports may contain implementations"
                echo "$IMPL_IN_PORTS"
              fi
            fi
          done
          
          echo "‚úÖ Port/Adapter separation check complete"

  # ==========================================================================
  # Domain-Driven Design Validation
  # ==========================================================================
  validate-ddd:
    name: "DDD: Bounded Contexts"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Subsystem Isolation
        run: |
          echo "=========================================="
          echo "DDD: Validating Bounded Contexts"
          echo "=========================================="
          
          # Check for cross-subsystem imports (FORBIDDEN)
          echo "Checking for direct subsystem coupling..."
          VIOLATIONS=0
          
          for subsystem in crates/qc-*/; do
            if [ -d "$subsystem" ]; then
              SUBSYSTEM_ID=$(basename "$subsystem" | cut -d'-' -f2)
              SUBSYSTEM_NAME=$(basename "$subsystem")
              
              echo "Analyzing: $SUBSYSTEM_NAME"
              
              # Find imports from other subsystems (exclude shared-*, tests, and doc comments)
              # grep output format is "filename:line_content" so we match doc comments after colon
              # Pattern: colon, optional whitespace, then //! or ///
              if grep -r "use qc_[0-9][0-9]_" "$subsystem/src" 2>/dev/null | grep -v "shared-" | grep -v "test" | grep -vE ":[[:space:]]*//[/!]"; then
                echo "‚ùå VIOLATION: $SUBSYSTEM_NAME has direct subsystem dependency!"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ All subsystems properly isolated"
          else
            echo "‚ùå Found $VIOLATIONS subsystem coupling violations"
            exit 1
          fi
      
      - name: Validate Domain Layer Purity
        run: |
          echo "=========================================="
          echo "DDD: Domain Layer Purity Check"
          echo "=========================================="

          # Domain layer must NOT contain direct I/O operations
          # Allowed exceptions:
          # - std::io::{Read, Write, Cursor} - traits used for in-memory streaming (compression, serialization)
          # - std::net::IpAddr, std::net::SocketAddr (data types, not I/O)
          # - test code and comments
          VIOLATIONS=0

          for domain_dir in crates/*/src/domain/; do
            if [ -d "$domain_dir" ]; then
              SUBSYSTEM=$(dirname "$(dirname "$domain_dir")" | xargs basename)
              echo "Checking domain purity: $SUBSYSTEM"

              # Check for ACTUAL I/O patterns (not just std::io traits)
              # Forbidden: tokio I/O, std::fs (file system), network sockets, File operations
              # Allowed: std::io::{Read, Write, Cursor} when used for in-memory streaming
              MATCHES=$(grep -rE "(tokio::fs::|tokio::net::|tokio::io::|std::fs::|TcpListener|TcpStream|UdpSocket|File::open|File::create)" "$domain_dir" 2>/dev/null | grep -v "test" | grep -v "^[[:space:]]*//") || true

              if [ -n "$MATCHES" ]; then
                echo "‚ùå VIOLATION: Domain layer contains I/O in $SUBSYSTEM"
                echo "$MATCHES"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done

          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ All domain layers are pure (no I/O)"
          else
            echo "‚ùå Found $VIOLATIONS domain purity violations"
            exit 1
          fi

  # ==========================================================================
  # Event-Driven Architecture Validation
  # ==========================================================================
  validate-eda:
    name: "EDA: Choreography Pattern"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Event-Only Communication
        run: |
          echo "=========================================="
          echo "EDA: Event-Driven Choreography"
          echo "=========================================="
          
          # Subsystems must use event bus, not direct calls
          VIOLATIONS=0
          
          for subsystem in crates/qc-*/src/service.rs; do
            if [ -f "$subsystem" ]; then
              SUBSYSTEM_NAME=$(dirname "$(dirname "$subsystem")" | xargs basename)
              echo "Checking: $SUBSYSTEM_NAME"
              
              # Check for event_bus usage
              if ! grep -q "event_bus" "$subsystem" 2>/dev/null; then
                echo "‚ö†Ô∏è WARNING: $SUBSYSTEM_NAME service may not use event bus"
              fi
              
              # Check for forbidden direct calls to other subsystems
              if grep -rE "self\.[a-z_]+_subsystem\." "$(dirname "$subsystem")" 2>/dev/null | grep -v "test" | grep -v "event_bus"; then
                echo "‚ùå VIOLATION: $SUBSYSTEM_NAME has direct subsystem calls"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ All subsystems use event-driven communication"
          else
            echo "‚ùå Found $VIOLATIONS choreography violations"
            exit 1
          fi
      
      - name: Validate Event Definitions
        run: |
          echo "=========================================="
          echo "EDA: Event Schema Validation"
          echo "=========================================="
          
          # Check that events are properly defined
          if [ -f "crates/shared-bus/src/events.rs" ]; then
            echo "Checking event definitions..."
            
            # Events must be in BlockchainEvent enum
            if ! grep -q "pub enum BlockchainEvent" crates/shared-bus/src/events.rs; then
              echo "‚ùå BlockchainEvent enum not found"
              exit 1
            fi
            
            echo "‚úÖ Event definitions validated"
          else
            echo "‚ö†Ô∏è shared-bus/events.rs not found"
          fi

  # ==========================================================================
  # Hexagonal Architecture Validation
  # ==========================================================================
  validate-hexagonal:
    name: "Hexagonal: Ports & Adapters"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Hexagonal Structure
        run: |
          echo "=========================================="
          echo "Hexagonal: Directory Structure"
          echo "=========================================="
          
          VIOLATIONS=0
          
          for subsystem in crates/qc-*/; do
            if [ -d "$subsystem/src" ]; then
              SUBSYSTEM_NAME=$(basename "$subsystem")
              echo "Checking: $SUBSYSTEM_NAME"
              
              # Required directories
              REQUIRED_DIRS=("domain" "ports" "adapters")
              for dir in "${REQUIRED_DIRS[@]}"; do
                if [ ! -d "$subsystem/src/$dir" ]; then
                  echo "‚ö†Ô∏è Missing: $subsystem/src/$dir"
                fi
              done
              
              # Ports must define traits
              if [ -d "$subsystem/src/ports" ]; then
                if ! grep -rq "trait" "$subsystem/src/ports" 2>/dev/null; then
                  echo "‚ö†Ô∏è No traits found in $SUBSYSTEM_NAME/ports"
                fi
              fi
            fi
          done
          
          echo "‚úÖ Hexagonal structure validated"
      
      - name: Validate Dependency Inversion
        run: |
          echo "=========================================="
          echo "Hexagonal: Dependency Inversion"
          echo "=========================================="
          
          # Domain must NOT depend on adapters
          for domain_dir in crates/*/src/domain/; do
            if [ -d "$domain_dir" ]; then
              SUBSYSTEM=$(dirname "$(dirname "$domain_dir")" | xargs basename)
              
              # Check domain doesn't import adapters
              if grep -r "use crate::adapters" "$domain_dir" 2>/dev/null; then
                echo "‚ùå VIOLATION: Domain depends on adapters in $SUBSYSTEM"
                exit 1
              fi
            fi
          done
          
          echo "‚úÖ Dependency inversion validated"

  # ==========================================================================
  # IPC Matrix Compliance
  # ==========================================================================
  validate-ipc-matrix:
    name: "IPC: Security Boundaries"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Envelope-Only Identity
        run: |
          echo "=========================================="
          echo "IPC: Envelope-Only Identity (Zero Trust)"
          echo "=========================================="
          
          # Payloads must NOT contain identity fields
          # EXCEPTION: AuthenticatedMessage envelope struct is allowed
          VIOLATIONS=0
          FORBIDDEN_FIELDS=("requester_id" "requester_subsystem" "sender_subsystem")
          
          for subsystem in crates/qc-*/src; do
            if [ -d "$subsystem" ]; then
              for field in "${FORBIDDEN_FIELDS[@]}"; do
                # Exclude: test files, envelope.rs, files with AuthenticatedMessage
                MATCHES=$(grep -rl "pub $field:" "$subsystem" 2>/dev/null | grep -v "test" | grep -v "envelope.rs") || true
                for file in $MATCHES; do
                  # Skip files that define AuthenticatedMessage (envelope wrappers)
                  if grep -q "struct AuthenticatedMessage" "$file" 2>/dev/null; then
                    continue
                  fi
                  echo "‚ùå VIOLATION: Found '$field' in $file (violates Envelope-Only Identity)"
                  VIOLATIONS=$((VIOLATIONS + 1))
                done
              done
            fi
          done
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "‚úÖ All payloads comply with Envelope-Only Identity"
          else
            echo "‚ùå Found $VIOLATIONS envelope violations"
            exit 1
          fi
      
      - name: Validate Signature Re-Verification
        run: |
          echo "=========================================="
          echo "IPC: Zero-Trust Signature Re-Verification"
          echo "=========================================="
          
          # Consensus must re-verify signatures (not trust QC-10)
          if [ -f "crates/qc-08-consensus/src/lib.rs" ]; then
            if grep -q "Zero-Trust Signature Re-Verification" crates/qc-08-consensus/src/lib.rs; then
              echo "‚úÖ Consensus implements zero-trust re-verification"
            else
              echo "‚ö†Ô∏è WARNING: Consensus may trust external validation"
            fi
          fi

  # ==========================================================================
  # IPC-MATRIX Cargo Dependency Validation (NEW - Phase 1)
  # Validates that Cargo.toml dependencies match IPC-MATRIX allowed list
  # ==========================================================================
  validate-ipc-cargo-deps:
    name: "IPC: Cargo Dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate IPC-MATRIX compliance via Cargo
        run: |
          echo "=========================================="
          echo "IPC-MATRIX: Cargo Dependency Validation"
          echo "=========================================="
          echo "Validates that subsystem dependencies match IPC-MATRIX.md"
          echo ""
          
          # IPC-MATRIX allowed communications (inline)
          # Format: SENDER_NUM -> ALLOWED_RECEIVERS
          get_allowed() {
            case "$1" in
              1)  echo "5 7 10 13" ;;
              2)  echo "3 6" ;;
              3)  echo "2 7 13" ;;
              4)  echo "6 11 12" ;;
              5)  echo "1 8" ;;
              6)  echo "4 8" ;;
              7)  echo "1 13" ;;
              8)  echo "2 3 4 5 6 9 10 12 14 15" ;;
              9)  echo "2 15" ;;
              10) echo "6 8" ;;
              11) echo "4 15" ;;
              12) echo "4 11" ;;
              13) echo "1 3 7" ;;
              14) echo "4 8" ;;
              15) echo "8 11" ;;
              16) echo "1 2 3 4 6 8 10 11" ;;
              17) echo "4 6 8 10" ;;
              *)  echo "" ;;
            esac
          }
          
          VIOLATIONS=0
          
          for crate in crates/qc-*/; do
            if [ -d "$crate" ]; then
              CRATE_NAME=$(basename "$crate")
              SENDER_NUM=$(echo "$CRATE_NAME" | grep -oE 'qc-([0-9]+)' | cut -d'-' -f2 | sed 's/^0//')
              
              if [ -z "$SENDER_NUM" ]; then continue; fi
              
              echo "Analyzing: $CRATE_NAME (Subsystem $SENDER_NUM)"
              
              # Get qc-* dependencies from Cargo.toml
              DEPS=$(grep -E '^\s*qc-[0-9]+-' "$crate/Cargo.toml" 2>/dev/null | \
                grep -oE 'qc-[0-9]+-[a-z-]+' | sort -u || true)
              
              ALLOWED=$(get_allowed "$SENDER_NUM")
              
              for dep in $DEPS; do
                RECEIVER_NUM=$(echo "$dep" | grep -oE 'qc-([0-9]+)' | cut -d'-' -f2 | sed 's/^0//')
                
                if [ -z "$RECEIVER_NUM" ]; then continue; fi
                
                # Check if receiver is in allowed list
                if ! echo "$ALLOWED" | grep -qw "$RECEIVER_NUM"; then
                  echo "‚ùå VIOLATION: Subsystem $SENDER_NUM cannot depend on Subsystem $RECEIVER_NUM"
                  echo "   Allowed: $ALLOWED"
                  VIOLATIONS=$((VIOLATIONS + 1))
                fi
              done
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå BLOCKED: $VIOLATIONS IPC-MATRIX violations detected"
            echo "Update Documentation/IPC-MATRIX.md if this dependency is intentional"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All Cargo dependencies comply with IPC-MATRIX"

  # ==========================================================================
  # Envelope-Only Identity - Exhaustive Check (NEW - Phase 1)
  # Catches ALL identity field patterns, not just 3
  # ==========================================================================
  validate-envelope-exhaustive:
    name: "IPC: Envelope Identity (Exhaustive)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Exhaustive Envelope-Only Identity Check
        run: |
          echo "=========================================="
          echo "IPC: Envelope-Only Identity (EXHAUSTIVE)"
          echo "=========================================="
          echo "Per Architecture.md Section 3.2.1:"
          echo "Payload identity fields are FORBIDDEN"
          echo "AuthenticatedMessage.sender_id is the ONLY source of truth"
          echo ""
          
          # Comprehensive list of forbidden identity field patterns
          FORBIDDEN_PATTERNS=(
            "requester_id"
            "requester_subsystem"
            "sender_subsystem"
            "source_id"
            "source_subsystem"
            "origin_id"
            "origin_subsystem"
            "from_subsystem"
            "caller_id"
            "caller_subsystem"
            "invoker_id"
            "client_id"
            "peer_subsystem"
          )
          
          VIOLATIONS=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            # Search in struct definitions only (field declarations)
            # Exclude: test files, envelope.rs, AuthenticatedMessage definitions, comments
            MATCHES=$(grep -rn "pub $pattern:" crates/qc-*/src 2>/dev/null | \
              grep -v "_test\.rs" | \
              grep -v "/tests/" | \
              grep -v "envelope.rs" | \
              grep -v "AuthenticatedMessage" | \
              grep -v "^[[:space:]]*//" || true)
            
            if [ -n "$MATCHES" ]; then
              echo "‚ùå VIOLATION: Identity field '$pattern' found in payload struct"
              echo "$MATCHES"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå ARCHITECTURAL VIOLATION: $VIOLATIONS envelope identity violations"
            echo ""
            echo "FIX: Remove identity fields from payload structs."
            echo "     Use envelope.sender_id from AuthenticatedMessage<T> instead."
            exit 1
          fi
          
          echo "‚úÖ All payloads comply with Envelope-Only Identity"

  # ==========================================================================
  # Choreography Pattern Enforcement (NEW - Phase 1)
  # Validates that state-modifying subsystems publish required events
  # ==========================================================================
  validate-choreography:
    name: "EDA: Choreography Events"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Required Event Publishing
        run: |
          echo "=========================================="
          echo "EDA: Choreography Event Publishing"
          echo "=========================================="
          echo "V2.3 Pattern: Subsystems publish events, not direct calls"
          echo ""
          
          VIOLATIONS=0
          
          # Subsystems that MUST publish specific events
          # Format: crate:EventName (can use regex pattern)
          MUST_PUBLISH=(
            "qc-08-consensus:BlockValidated"
            "qc-03-transaction-indexing:MerkleRootComputed"
            "qc-04-state-management:StateRootComputed"
            "qc-02-block-storage:BlockStored"
            "qc-17-block-production:BlockProduced"
          )
          
          for spec in "${MUST_PUBLISH[@]}"; do
            CRATE=$(echo "$spec" | cut -d: -f1)
            EVENT=$(echo "$spec" | cut -d: -f2)
            
            if [ -d "crates/$CRATE/src" ]; then
              if ! grep -rq "$EVENT" "crates/$CRATE/src" 2>/dev/null; then
                echo "‚ùå VIOLATION: $CRATE must publish $EVENT event"
                VIOLATIONS=$((VIOLATIONS + 1))
              else
                echo "‚úÖ $CRATE publishes $EVENT"
              fi
            fi
          done
          
          echo ""
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå BLOCKED: $VIOLATIONS choreography violations"
            exit 1
          fi
      
      - name: Validate Block Storage as Stateful Assembler
        run: |
          echo "=========================================="
          echo "EDA: Block Storage Stateful Assembler"
          echo "=========================================="
          echo "V2.3: Block Storage must subscribe to 3 events for assembly"
          echo ""
          
          REQUIRED_SUBSCRIPTIONS=(
            "BlockValidated"
            "MerkleRootComputed"
            "StateRootComputed"
          )
          
          MISSING=0
          for sub in "${REQUIRED_SUBSCRIPTIONS[@]}"; do
            if grep -rq "$sub" crates/qc-02-block-storage/src 2>/dev/null; then
              echo "‚úÖ Block Storage handles $sub"
            else
              echo "‚ö†Ô∏è WARNING: Block Storage may not handle $sub"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è Block Storage may not implement Stateful Assembler correctly"
          fi

  # ==========================================================================
  # Architecture Version Drift Detection (NEW - Phase 1)
  # ==========================================================================
  validate-version-drift:
    name: "Docs: Version Drift"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Architecture Version Consistency
        run: |
          echo "=========================================="
          echo "Architecture Version Consistency"
          echo "=========================================="
          echo "Current version: ${{ env.ARCHITECTURE_VERSION }}"
          echo ""
          
          VIOLATIONS=0
          
          # Check workflow files reference current version
          OLD_REFS=$(grep -rE "Architecture\.md V[0-9]\.[0-9]" .github/workflows/ | \
            grep -v "${{ env.ARCHITECTURE_VERSION }}" || true)
          
          if [ -n "$OLD_REFS" ]; then
            echo "‚ùå Outdated architecture references in workflows:"
            echo "$OLD_REFS"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check CLAUDE.md
          if ! grep -q "Architecture.md ${{ env.ARCHITECTURE_VERSION }}" CLAUDE.md 2>/dev/null; then
            echo "‚ö†Ô∏è CLAUDE.md may reference outdated architecture version"
          fi
          
          # Check IPC-MATRIX.md has version marker
          if ! grep -qE "v2\.[23]|V2\.[23]" Documentation/IPC-MATRIX.md 2>/dev/null; then
            echo "‚ö†Ô∏è IPC-MATRIX.md may need version update"
          fi
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Architecture version drift detected"
            exit 1
          fi
          
          echo "‚úÖ All architecture references consistent"

  # ==========================================================================
  # Signed Commits Verification (NEW - Phase 0)
  # ==========================================================================
  signed-commits:
    name: "Security: Signed Commits"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify GPG Signatures
        run: |
          echo "=========================================="
          echo "Signed Commits Verification"
          echo "=========================================="
          
          # Check commits in this PR
          UNSIGNED=$(git log --pretty=format:'%H %G?' origin/${{ github.base_ref }}..HEAD 2>/dev/null | \
            grep -v ' G$' | grep -v ' E$' | grep -v ' U$' || true)
          
          if [ -n "$UNSIGNED" ]; then
            echo "‚ö†Ô∏è WARNING: Unsigned commits detected"
            echo "$UNSIGNED"
            echo ""
            echo "Recommendation: Sign your commits with GPG"
            echo "  git config commit.gpgsign true"
            # Advisory for now - upgrade to blocking later
          else
            echo "‚úÖ All commits signed (or no commits to check)"
          fi
      
      - name: Check DCO Sign-off
        run: |
          echo "=========================================="
          echo "DCO Sign-off Check"
          echo "=========================================="
          
          MISSING=$(git log --pretty=format:'%H' origin/${{ github.base_ref }}..HEAD 2>/dev/null | while read hash; do
            if ! git log -1 --format='%B' "$hash" 2>/dev/null | grep -q '^Signed-off-by:'; then
              echo "$hash"
            fi
          done || true)
          
          if [ -n "$MISSING" ]; then
            echo "‚ö†Ô∏è WARNING: Commits missing DCO sign-off"
            echo "Run: git commit --amend --signoff"
            # Advisory for now
          else
            echo "‚úÖ All commits have DCO sign-off (or no commits to check)"
          fi

  # ==========================================================================
  # Architecture Documentation Sync
  # ==========================================================================
  validate-documentation:
    name: "Docs: Architecture Sync"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Documentation Exists
        run: |
          echo "=========================================="
          echo "Architecture Documentation Validation"
          echo "=========================================="
          
          REQUIRED_DOCS=(
            "Documentation/Architecture.md"
            "Documentation/IPC-MATRIX.md"
            "Documentation/System.md"
            "CLAUDE.md"
          )
          
          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing: $doc"
              MISSING=$((MISSING + 1))
            else
              echo "‚úÖ Found: $doc"
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå $MISSING required documents missing"
            exit 1
          fi
      
      - name: Validate Architecture Version
        run: |
          # All references must be to Architecture.md V2.3
          if grep -r "Architecture.md V[0-9]" .github/workflows/ | grep -v "V2.3"; then
            echo "‚ö†Ô∏è WARNING: Found references to old architecture versions"
          else
            echo "‚úÖ All references use Architecture V2.3"
          fi

  # ==========================================================================
  # Summary Report
  # ==========================================================================
  architect-summary:
    name: "Summary: Architecture Report"
    runs-on: ubuntu-latest
    needs: [pr-governance, validate-ddd, validate-eda, validate-hexagonal, validate-ipc-matrix, validate-ipc-cargo-deps, validate-envelope-exhaustive, validate-choreography, validate-version-drift, signed-commits, validate-documentation, typosquat-check, arch-test]
    if: always()
    steps:
      - name: Check Critical Failures
        run: |
          FAILED=0
          
          # Critical jobs that MUST pass
          if [[ "${{ needs.validate-ddd.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-eda.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-hexagonal.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-ipc-matrix.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-ipc-cargo-deps.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-envelope-exhaustive.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.validate-choreography.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.typosquat-check.result }}" == "failure" ]]; then FAILED=1; fi
          if [[ "${{ needs.arch-test.result }}" == "failure" ]]; then FAILED=1; fi
          
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå ARCHITECTURE VALIDATION FAILED"
            echo "Zero tolerance mode: ${{ env.ZERO_TOLERANCE }}"
            exit 1
          fi
          
          echo "‚úÖ All architecture checks passed"
      
      - name: Generate Architecture Report
        if: always()
        run: |
          echo "## üèõÔ∏è Master Architect Report (Fortress Edition)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Core Pattern Validation" >> $GITHUB_STEP_SUMMARY
          echo "| Pattern | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| DDD (Bounded Contexts) | ${{ needs.validate-ddd.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EDA (Choreography) | ${{ needs.validate-eda.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hexagonal (Ports & Adapters) | ${{ needs.validate-hexagonal.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IPC Matrix (Security Boundaries) | ${{ needs.validate-ipc-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fortress Upgrades (Phase 1)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| IPC Cargo Dependencies | ${{ needs.validate-ipc-cargo-deps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Envelope-Only Identity (Exhaustive) | ${{ needs.validate-envelope-exhaustive.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Choreography Events | ${{ needs.validate-choreography.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Drift | ${{ needs.validate-version-drift.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Signed Commits | ${{ needs.signed-commits.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Typosquat Detection | ${{ needs.typosquat-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Domain Layer Purity | ${{ needs.arch-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.validate-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architectural Laws (Zero Tolerance)" >> $GITHUB_STEP_SUMMARY
          echo "- **LAW #1**: Subsystem Isolation (Bounded Contexts)" >> $GITHUB_STEP_SUMMARY
          echo "- **LAW #2**: Event Bus Only Communication" >> $GITHUB_STEP_SUMMARY
          echo "- **LAW #3**: Envelope-Only Identity (Zero Trust)" >> $GITHUB_STEP_SUMMARY
          echo "- **LAW #4**: Test-Driven Development" >> $GITHUB_STEP_SUMMARY
          echo "- **LAW #5**: Check Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### IPC-MATRIX Compliance" >> $GITHUB_STEP_SUMMARY
          echo "All subsystem dependencies validated against \`Documentation/IPC-MATRIX.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Architecture Version: ${{ env.ARCHITECTURE_VERSION }}*" >> $GITHUB_STEP_SUMMARY

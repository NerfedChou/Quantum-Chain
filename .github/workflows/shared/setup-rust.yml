# ==============================================================================
# SHARED WORKFLOW - Rust Toolchain Setup with Caching
# ==============================================================================
# Purpose: Centralized Rust installation with optimized caching
# Impact: Saves 2-3 minutes per workflow via compilation cache
# Usage: uses: ./.github/workflows/shared/setup-rust.yml
# ==============================================================================

name: "Setup Rust Toolchain"

on:
  workflow_call:
    inputs:
      toolchain:
        description: 'Rust toolchain version'
        type: string
        default: 'stable'
      components:
        description: 'Additional components (comma-separated)'
        type: string
        default: 'rustfmt,clippy'
      cache-key-suffix:
        description: 'Additional cache key suffix'
        type: string
        default: ''

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm-dev

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.toolchain }}
          components: ${{ inputs.components }}

      - name: Setup Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "quantum-chain-${{ inputs.toolchain }}${{ inputs.cache-key-suffix }}"
          cache-targets: true
          cache-on-failure: true
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

      - name: Cache Cargo Registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Verify Installation
        run: |
          rustc --version
          cargo --version
          rustfmt --version || echo "rustfmt not installed"
          cargo clippy --version || echo "clippy not installed"

# ==============================================================================
# Quantum-Chain Rust CI Pipeline
# ==============================================================================
# Comprehensive CI for the modular blockchain system.
#
# Architecture Reference: 
#   - Documentation/Architecture.md V2.3
#   - Documentation/System.md (15 Subsystems)
#   - Documentation/IPC-MATRIX.md (Inter-subsystem Communication)
#
# SUBSYSTEM ARCHITECTURE:
#   The system comprises 15 independent subsystems, each as a separate crate:
#   - qc-01-peer-discovery    : Kademlia DHT, peer routing
#   - qc-02-block-storage     : Stateful Assembler, block persistence
#   - qc-03-transaction-indexing : Merkle tree computation
#   - qc-04-state-management  : World state, MPT trie
#   - qc-05-block-propagation : Network block relay
#   - qc-06-mempool           : Transaction pool management
#   - qc-07-bloom-filters     : SPV client support
#   - qc-08-consensus         : Block validation (Choreography)
#   - qc-09-finality          : PoS finality gadget
#   - qc-10-signature-verification : Pure crypto service
#   - qc-11-smart-contracts   : VM execution engine
#   - qc-12-transaction-ordering : Parallel execution scheduling
#   - qc-13-light-client-sync : Light client protocol
#   - qc-14-sharding          : Shard coordination
#   - qc-15-cross-chain       : Bridge & HTLC
#
# Jobs:
#   - check: Fast feedback (format, clippy)
#   - build: Compile all crates
#   - test: Run unit and integration tests
#   - test-subsystems: Individual subsystem isolation tests
#   - integration: Cross-subsystem integration tests
#   - docs: Build documentation
#   - security: Audit dependencies
# ==============================================================================

name: Rust CI

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/rust.yml'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/rust.yml'
  workflow_dispatch:
    inputs:
      full_test:
        description: 'Run full test suite including integration tests'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUST_BACKTRACE: 1
  # Subsystem count for validation
  EXPECTED_SUBSYSTEM_COUNT: 15

jobs:
  # ============================================================================
  # Fast Checks - Format and Lint
  # ============================================================================
  check:
    name: Check (Format & Lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy (all features)
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ============================================================================
  # Build - All Crates
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: check
    strategy:
      matrix:
        include:
          - profile: debug
            args: ""
          - profile: release
            args: "--release"
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ matrix.profile }}-
      
      - name: Build all crates (${{ matrix.profile }})
        run: cargo build --all ${{ matrix.args }} --verbose
      
      - name: Build all features
        run: cargo build --all --all-features ${{ matrix.args }}

  # ============================================================================
  # Test - Unit and Integration Tests
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-debug-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run unit tests
        run: cargo test --all --verbose
      
      - name: Run tests with all features
        run: cargo test --all --all-features --verbose

  # ============================================================================
  # Test Subsystems - Individual Isolation Testing
  # Architecture Reference: System.md - Each subsystem is independent
  # ============================================================================
  test-subsystems:
    name: Test Subsystems
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        subsystem:
          - { id: "01", name: "peer-discovery", deps: "10" }
          - { id: "02", name: "block-storage", deps: "3,4,8" }
          - { id: "03", name: "transaction-indexing", deps: "2,10" }
          - { id: "04", name: "state-management", deps: "11" }
          - { id: "05", name: "block-propagation", deps: "1,8,10" }
          - { id: "06", name: "mempool", deps: "4,10" }
          - { id: "07", name: "bloom-filters", deps: "1,3" }
          - { id: "08", name: "consensus", deps: "4,5,6,10" }
          - { id: "09", name: "finality", deps: "4,8,10" }
          - { id: "10", name: "signature-verification", deps: "" }
          - { id: "11", name: "smart-contracts", deps: "4,10" }
          - { id: "12", name: "transaction-ordering", deps: "4,11" }
          - { id: "13", name: "light-client-sync", deps: "1,3,7" }
          - { id: "14", name: "sharding", deps: "4,8" }
          - { id: "15", name: "cross-chain", deps: "9,11" }
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-debug-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Test Subsystem ${{ matrix.subsystem.id }} (${{ matrix.subsystem.name }})
        run: |
          CRATE_NAME="qc-${{ matrix.subsystem.id }}-${{ matrix.subsystem.name }}"
          echo "=========================================="
          echo "Testing: $CRATE_NAME"
          echo "Dependencies: ${{ matrix.subsystem.deps }}"
          echo "Reference: SPECS/SPEC-${{ matrix.subsystem.id }}-*.md"
          echo "=========================================="
          
          if [ -d "crates/$CRATE_NAME" ]; then
            cargo test -p $CRATE_NAME --verbose
          else
            echo "Crate $CRATE_NAME not found, skipping..."
          fi
      
      - name: Validate IPC contracts for Subsystem ${{ matrix.subsystem.id }}
        run: |
          # Validate that subsystem follows IPC-MATRIX.md rules
          CRATE_DIR="crates/qc-${{ matrix.subsystem.id }}-${{ matrix.subsystem.name }}"
          if [ -d "$CRATE_DIR/src" ]; then
            echo "Checking IPC compliance for Subsystem ${{ matrix.subsystem.id }}..."
            # Check for requester_id in payloads (should NOT exist per Envelope-Only Identity)
            if grep -r "requester_id" "$CRATE_DIR/src" 2>/dev/null; then
              echo "WARNING: Found 'requester_id' in payload - violates Envelope-Only Identity (Architecture.md V2.3)"
            fi
          fi

  # ============================================================================
  # Integration Tests - Cross-Subsystem Communication
  # Architecture Reference: IPC-MATRIX.md, Architecture.md Section 5
  # ============================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test, test-subsystems]
    if: github.event_name == 'push' || github.event.inputs.full_test == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-debug-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run integration tests
        run: |
          echo "Running cross-subsystem integration tests..."
          cargo test --all --features integration --verbose 2>/dev/null || echo "Integration tests not yet implemented"
      
      - name: Validate Choreography Pattern
        run: |
          echo "=========================================="
          echo "Validating Block Creation Choreography"
          echo "Reference: Architecture.md Section 5.1"
          echo "=========================================="
          echo "Flow: Consensus(8) -> BlockValidated"
          echo "      Transaction Indexing(3) -> MerkleRootComputed"
          echo "      State Management(4) -> StateRootComputed"
          echo "      Block Storage(2) assembles all three"
          echo ""
          # This would run actual integration tests when implemented
          echo "Choreography validation: PENDING IMPLEMENTATION"
      
      - name: Validate IPC-MATRIX Compliance
        run: |
          echo "=========================================="
          echo "Validating IPC-MATRIX.md Compliance"
          echo "=========================================="
          # Check that no subsystem talks to forbidden targets
          echo "IPC-MATRIX compliance: PENDING IMPLEMENTATION"

  # ============================================================================
  # Documentation - Build and Verify
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build documentation
        run: cargo doc --all --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"
      
      - name: Check documentation links
        run: cargo doc --all --no-deps
        env:
          RUSTDOCFLAGS: "-D warnings --check"

  # ============================================================================
  # Security - Dependency Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Don't fail build on advisories, just report

  # ============================================================================
  # Summary Job
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [check, build, test, test-subsystems, docs]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.check.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.test-subsystems.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
      
      - name: Generate CI Summary
        run: |
          echo "## Quantum-Chain CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Check (Format & Lint) | ${{ needs.check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Subsystem Tests | ${{ needs.test-subsystems.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture References" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture.md V2.3**: Core patterns and choreography" >> $GITHUB_STEP_SUMMARY
          echo "- **System.md**: 15 Subsystem definitions" >> $GITHUB_STEP_SUMMARY
          echo "- **IPC-MATRIX.md**: Inter-subsystem communication rules" >> $GITHUB_STEP_SUMMARY

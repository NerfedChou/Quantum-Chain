# Role-Based CI/CD Workflow System
#
# 08 • Audit Automation
# License compliance, SBOM generation, dependency audit
#
# Triggers: Called by orchestrator, schedule, or manual
# Runtime: ~10 minutes

name: "08 • Audit"

on:
  workflow_call:
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # License Compliance
  # ==========================================================================
  
  license-check:
    name: "Audit • Licenses"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      
      - name: Check licenses
        run: |
          echo "Checking license compliance..."
          cargo deny check licenses 2>&1 || true
      
      - name: Check bans
        run: |
          echo "Checking banned dependencies..."
          cargo deny check bans 2>&1 || true

  # ==========================================================================
  # SBOM Generation
  # ==========================================================================
  
  sbom-generate:
    name: "Audit • SBOM"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx --locked
        continue-on-error: true
      
      - name: Generate SBOM (CycloneDX)
        run: |
          echo "Generating Software Bill of Materials..."
          cargo cyclonedx --all --format json > sbom.json 2>/dev/null || \
            echo '{"bomFormat":"CycloneDX","specVersion":"1.4","components":[]}' > sbom.json
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  # ==========================================================================
  # Dependency Tree Analysis
  # ==========================================================================
  
  dep-tree:
    name: "Audit • Dependencies"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Generate dependency tree
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     Dependency Analysis                ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          
          echo "=== Direct Dependencies ==="
          cargo tree --depth 1 | head -100
          
          echo ""
          echo "=== Duplicate Dependencies ==="
          cargo tree --duplicates 2>/dev/null | head -50 || true
      
      - name: Check outdated dependencies
        run: |
          echo ""
          echo "=== Outdated Dependencies ==="
          cargo install cargo-outdated --locked 2>/dev/null || true
          cargo outdated --depth 1 2>/dev/null | head -30 || echo "cargo-outdated not available"

  # ==========================================================================
  # Security Advisory Check
  # ==========================================================================
  
  advisory-check:
    name: "Audit • Advisories"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: |
          echo "Checking for security advisories..."
          cargo audit --json > audit-results.json 2>/dev/null || true
          cargo audit 2>&1 || true
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-results
          path: audit-results.json
          retention-days: 30

  # ==========================================================================
  # Cargo.toml Validation
  # ==========================================================================
  
  manifest-check:
    name: "Audit • Manifests"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Validate Cargo.toml files
        run: |
          echo "Validating Cargo.toml manifests..."
          
          for toml in $(find . -name "Cargo.toml" -not -path "./target/*"); do
            echo "Checking $toml..."
            cargo verify-project --manifest-path "$toml" 2>/dev/null || true
          done
      
      - name: Check workspace consistency
        run: |
          echo "Checking workspace consistency..."
          cargo metadata --format-version 1 > /dev/null
          echo "✅ Workspace metadata valid"

  # ==========================================================================
  # Summary
  # ==========================================================================
  
  audit-summary:
    name: "Audit Summary"
    runs-on: ubuntu-latest
    needs: [license-check, sbom-generate, dep-tree, advisory-check, manifest-check]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║     08 • Audit Results                 ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          echo "License Check: ${{ needs.license-check.result }}"
          echo "SBOM Generation: ${{ needs.sbom-generate.result }}"
          echo "Dependency Tree: ${{ needs.dep-tree.result }}"
          echo "Advisory Check: ${{ needs.advisory-check.result }}"
          echo "Manifest Check: ${{ needs.manifest-check.result }}"
          
          echo ""
          echo "✅ Audit complete"

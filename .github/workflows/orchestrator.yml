# Role-Based CI/CD Workflow System
#
# 00 • Orchestrator
# Master workflow that coordinates all role-based workflows
#
# This is the SINGLE ENTRY POINT for CI/CD
# It calls each specialized workflow in the correct order

name: "00 • Orchestrator"

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      skip-slow:
        description: "Skip slow workflows (optimization, testing)"
        type: boolean
        default: true
      full-suite:
        description: "Run full test suite including load tests"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # PHASE 1: Fast Feedback (< 5 minutes)
  # These run on EVERY push/PR
  # ==========================================================================
  
  architect:
    name: "01 • Architect"
    uses: ./.github/workflows/01-architect/validate-architecture.yml
    secrets: inherit
  
  quality:
    name: "02 • Quality"
    uses: ./.github/workflows/02-quality/code-quality.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 2: Core Testing (< 15 minutes)
  # Runs after Phase 1 passes
  # ==========================================================================
  
  security:
    name: "03 • Security"
    needs: [architect, quality]
    uses: ./.github/workflows/03-security/unit-integration-tests.yml
    secrets: inherit
  
  scalability:
    name: "04 • Scalability"
    needs: [architect, quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/04-scalability/scalability.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 3: Security Deep Dive (< 10 minutes)
  # ==========================================================================
  
  zero-day:
    name: "05 • Zero-Day"
    needs: [security]
    uses: ./.github/workflows/05-zero-day/vulnerability-scanning.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 4: Production Readiness
  # Only on main branch or manual trigger
  # ==========================================================================
  
  production:
    name: "06 • Production"
    needs: [security, zero-day]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/06-production/docker-builds.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 5: Quality Assurance
  # ==========================================================================
  
  qa:
    name: "09 • QA"
    needs: [security]
    uses: ./.github/workflows/09-qa/quality-assurance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 6: Compliance (Weekly or Manual)
  # ==========================================================================
  
  audit:
    name: "08 • Audit"
    needs: [security]
    if: github.event_name == 'workflow_dispatch' || github.event.schedule
    uses: ./.github/workflows/08-audit/compliance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 7: Performance (Nightly or Manual)
  # ==========================================================================
  
  optimization:
    name: "07 • Optimization"
    needs: [security]
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.skip-slow != true) ||
      github.event.schedule
    uses: ./.github/workflows/07-optimization/benchmarks.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 8: Load Testing (Manual Only)
  # ==========================================================================
  
  testing:
    name: "10 • Testing"
    needs: [qa, production]
    if: github.event_name == 'workflow_dispatch' && inputs.full-suite == true
    uses: ./.github/workflows/10-testing/load-stress.yml
    secrets: inherit

  # ==========================================================================
  # Summary Gate
  # ==========================================================================
  
  ci-success:
    name: "✅ CI Success"
    runs-on: ubuntu-latest
    needs: [architect, quality, security, zero-day]
    if: always()
    
    steps:
      - name: Check critical jobs
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║              CI/CD Pipeline Summary                        ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Phase 1 - Fast Feedback:"
          echo "  01 • Architect: ${{ needs.architect.result }}"
          echo "  02 • Quality:   ${{ needs.quality.result }}"
          echo ""
          echo "Phase 2 - Core Testing:"
          echo "  03 • Security:  ${{ needs.security.result }}"
          echo ""
          echo "Phase 3 - Security:"
          echo "  05 • Zero-Day:  ${{ needs.zero-day.result }}"
          echo ""
          
          # Check for failures in critical jobs
          if [[ "${{ needs.architect.result }}" == "failure" ]] || \
             [[ "${{ needs.quality.result }}" == "failure" ]] || \
             [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.zero-day.result }}" == "failure" ]]; then
            echo "❌ CI FAILED - Critical jobs did not pass"
            exit 1
          fi
          
          echo "✅ All critical CI checks passed!"
          echo ""
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

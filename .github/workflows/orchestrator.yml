# Role-Based CI/CD Workflow System
#
# 00 â€¢ Orchestrator
# Master workflow that coordinates all role-based workflows
#
# This is the SINGLE ENTRY POINT for CI/CD
# It calls each specialized workflow in the correct order

name: "00 â€¢ Orchestrator"

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      skip-slow:
        description: "Skip slow workflows (optimization, testing)"
        type: boolean
        default: true
      full-suite:
        description: "Run full test suite including load tests"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # PHASE 1: Fast Feedback (< 5 minutes)
  # These run on EVERY push/PR
  # ==========================================================================
  
  architect:
    name: "01 â€¢ Architect"
    uses: ./.github/workflows/01-architect/validate-architecture.yml
    secrets: inherit
  
  quality:
    name: "02 â€¢ Quality"
    uses: ./.github/workflows/02-quality/code-quality.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 2: Core Testing (< 15 minutes)
  # Runs after Phase 1 passes
  # ==========================================================================
  
  security:
    name: "03 â€¢ Security"
    needs: [architect, quality]
    uses: ./.github/workflows/03-security/unit-integration-tests.yml
    secrets: inherit
  
  scalability:
    name: "04 â€¢ Scalability"
    needs: [architect, quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/04-scalability/scalability.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 3: Security Deep Dive (< 10 minutes)
  # ==========================================================================
  
  zero-day:
    name: "05 â€¢ Zero-Day"
    needs: [security]
    uses: ./.github/workflows/05-zero-day/vulnerability-scanning.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 4: Production Readiness
  # Only on main branch or manual trigger
  # ==========================================================================
  
  production:
    name: "06 â€¢ Production"
    needs: [security, zero-day]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/06-production/docker-builds.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 5: Quality Assurance
  # ==========================================================================
  
  qa:
    name: "09 â€¢ QA"
    needs: [security]
    uses: ./.github/workflows/09-qa/quality-assurance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 6: Compliance (Weekly or Manual)
  # ==========================================================================
  
  audit:
    name: "08 â€¢ Audit"
    needs: [security]
    if: github.event_name == 'workflow_dispatch' || github.event.schedule
    uses: ./.github/workflows/08-audit/compliance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 7: Performance (Nightly or Manual)
  # ==========================================================================
  
  optimization:
    name: "07 â€¢ Optimization"
    needs: [security]
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.skip-slow != true) ||
      github.event.schedule
    uses: ./.github/workflows/07-optimization/benchmarks.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 8: Load Testing (Manual Only)
  # ==========================================================================
  
  testing:
    name: "10 â€¢ Testing"
    needs: [qa, production]
    if: github.event_name == 'workflow_dispatch' && inputs.full-suite == true
    uses: ./.github/workflows/10-testing/load-stress.yml
    secrets: inherit

  # ==========================================================================
  # Summary Gate
  # ==========================================================================
  
  ci-success:
    name: "âœ… CI Success"
    runs-on: ubuntu-latest
    needs: [architect, quality, security, zero-day]
    if: always()
    
    steps:
      - name: Check critical jobs
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              CI/CD Pipeline Summary                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Phase 1 - Fast Feedback:"
          echo "  01 â€¢ Architect: ${{ needs.architect.result }}"
          echo "  02 â€¢ Quality:   ${{ needs.quality.result }}"
          echo ""
          echo "Phase 2 - Core Testing:"
          echo "  03 â€¢ Security:  ${{ needs.security.result }}"
          echo ""
          echo "Phase 3 - Security:"
          echo "  05 â€¢ Zero-Day:  ${{ needs.zero-day.result }}"
          echo ""
          
          # Check for failures in critical jobs
          if [[ "${{ needs.architect.result }}" == "failure" ]] || \
             [[ "${{ needs.quality.result }}" == "failure" ]] || \
             [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.zero-day.result }}" == "failure" ]]; then
            echo "âŒ CI FAILED - Critical jobs did not pass"
            exit 1
          fi
          
          echo "âœ… All critical CI checks passed!"
          echo ""
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Generate CI Metrics Dashboard
        if: always()
        run: |
          echo "## ðŸ“Š CI/CD Pipeline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Workflow | Status | Critical |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Fast Feedback | 01 â€¢ Architect | ${{ needs.architect.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Fast Feedback | 02 â€¢ Quality | ${{ needs.quality.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Core Testing | 03 â€¢ Security | ${{ needs.security.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ Security | 05 â€¢ Zero-Day | ${{ needs.zero-day.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add performance insights
          echo "### ðŸš€ Performance Insights" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Fast Feedback**: Critical checks complete in ~5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Incremental Testing**: Only changed crates tested (60-80% faster)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shared Cache**: Rust toolchain cached across workflows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add architecture compliance
          echo "### ðŸ›ï¸ Architecture Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Subsystem Isolation (Bounded Contexts)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Event-Driven Choreography" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Envelope-Only Identity (Zero Trust)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test-Driven Development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add commit info
          echo "### ðŸ“ Commit Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

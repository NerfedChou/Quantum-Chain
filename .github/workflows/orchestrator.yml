# ==============================================================================
# CI/CD ORCHESTRATOR - FORTRESS EDITION
# ==============================================================================
# Master workflow that coordinates all role-based workflows
# 
# This is the SINGLE ENTRY POINT for CI/CD
# It calls each specialized workflow in the correct order
#
# ZERO TOLERANCE: All critical checks BLOCK merge. No exceptions.
# ==============================================================================

name: "00 â€¢ Orchestrator"

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      skip-slow:
        description: "Skip slow workflows (optimization, testing)"
        type: boolean
        default: true
      full-suite:
        description: "Run full test suite including load tests"
        type: boolean
        default: false
      zero-tolerance:
        description: "Enable zero tolerance mode (block on any failure)"
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Fortress mode: ALL violations block merge
  ZERO_TOLERANCE: ${{ github.event.inputs.zero-tolerance || 'true' }}

jobs:
  # ==========================================================================
  # PHASE 1: Fast Feedback (< 5 minutes)
  # These run on EVERY push/PR - CRITICAL GATE
  # ==========================================================================
  
  architect:
    name: "01 â€¢ Architect"
    uses: ./.github/workflows/01-validate-architecture.yml
    secrets: inherit
  
  quality:
    name: "02 â€¢ Quality"
    uses: ./.github/workflows/02-code-quality.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 2: Core Testing (< 15 minutes)
  # Runs after Phase 1 passes
  # ==========================================================================
  
  security:
    name: "03 â€¢ Security"
    needs: [architect, quality]
    uses: ./.github/workflows/03-unit-integration-tests.yml
    secrets: inherit
  
  scalability:
    name: "04 â€¢ Scalability"
    needs: [architect, quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/04-scalability.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 3: Security Deep Dive (< 10 minutes)
  # ==========================================================================
  
  zero-day:
    name: "05 â€¢ Zero-Day"
    needs: [security]
    uses: ./.github/workflows/05-vulnerability-scanning.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 4: Production Readiness
  # Only on main branch or manual trigger
  # ==========================================================================
  
  production:
    name: "06 â€¢ Production"
    needs: [security, zero-day]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/06-docker-builds.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 5: Quality Assurance
  # ==========================================================================
  
  qa:
    name: "09 â€¢ QA"
    needs: [security]
    uses: ./.github/workflows/09-quality-assurance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 6: Compliance (Weekly or Manual)
  # ==========================================================================
  
  audit:
    name: "08 â€¢ Audit"
    needs: [security]
    if: github.event_name == 'workflow_dispatch' || github.event.schedule
    uses: ./.github/workflows/08-compliance.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 7: Performance (Nightly or Manual)
  # ==========================================================================
  
  optimization:
    name: "07 â€¢ Optimization"
    needs: [security]
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.skip-slow != true) ||
      github.event.schedule
    uses: ./.github/workflows/07-benchmarks.yml
    secrets: inherit

  # ==========================================================================
  # PHASE 8: Load Testing (Manual Only)
  # ==========================================================================
  
  testing:
    name: "10 â€¢ Testing"
    needs: [qa, production]
    if: github.event_name == 'workflow_dispatch' && inputs.full-suite == true
    uses: ./.github/workflows/10-load-stress.yml
    secrets: inherit

  # ==========================================================================
  # Summary Gate - FORTRESS EDITION
  # ==========================================================================
  
  ci-success:
    name: "âœ… CI Success"
    runs-on: ubuntu-latest
    needs: [architect, quality, security, zero-day]
    if: always()
    
    steps:
      - name: Check critical jobs
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         CI/CD FORTRESS - Pipeline Summary                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Zero Tolerance Mode: ${{ env.ZERO_TOLERANCE }}"
          echo ""
          echo "Phase 1 - Fast Feedback (Architecture + Quality):"
          echo "  01 â€¢ Architect: ${{ needs.architect.result }}"
          echo "  02 â€¢ Quality:   ${{ needs.quality.result }}"
          echo ""
          echo "Phase 2 - Core Testing:"
          echo "  03 â€¢ Security:  ${{ needs.security.result }}"
          echo ""
          echo "Phase 3 - Security Deep Dive:"
          echo "  05 â€¢ Zero-Day:  ${{ needs.zero-day.result }}"
          echo ""
          
          # Check for failures in critical jobs
          FAILED=0
          if [[ "${{ needs.architect.result }}" == "failure" ]]; then
            echo "âŒ BLOCKED: Architecture validation failed"
            FAILED=1
          fi
          if [[ "${{ needs.quality.result }}" == "failure" ]]; then
            echo "âŒ BLOCKED: Code quality checks failed"
            FAILED=1
          fi
          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "âŒ BLOCKED: Security tests failed"
            FAILED=1
          fi
          if [[ "${{ needs.zero-day.result }}" == "failure" ]]; then
            echo "âŒ BLOCKED: Vulnerability scanning failed"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         âŒ CI FORTRESS BLOCKED THIS MERGE                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         âœ… ALL CRITICAL CHECKS PASSED                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Generate CI Metrics Dashboard
        if: always()
        run: |
          echo "## ðŸ° CI/CD Fortress Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Workflow | Status | Critical |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Fast Feedback | 01 â€¢ Architect | ${{ needs.architect.result }} | ðŸ”´ BLOCKING |" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Fast Feedback | 02 â€¢ Quality | ${{ needs.quality.result }} | ðŸ”´ BLOCKING |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Core Testing | 03 â€¢ Security | ${{ needs.security.result }} | ðŸ”´ BLOCKING |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ Security | 05 â€¢ Zero-Day | ${{ needs.zero-day.result }} | ðŸ”´ BLOCKING |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Fortress features
          echo "### ðŸ° Fortress Features Active" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Zero Tolerance Mode | ${{ env.ZERO_TOLERANCE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IPC-MATRIX Enforcement | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Envelope-Only Identity | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Choreography Validation | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Locked Build (--locked) | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Miri Memory Safety | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add architecture compliance
          echo "### ðŸ›ï¸ Architecture Compliance (V2.3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LAW #1: Subsystem Isolation (Bounded Contexts)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LAW #2: Event Bus Only Communication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LAW #3: Envelope-Only Identity (Zero Trust)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LAW #4: Test-Driven Development" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LAW #5: Check Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add commit info
          echo "### ðŸ“ Commit Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

# ==============================================================================
# Quantum-Chain Development Docker Compose
# ==============================================================================
# Fast iteration environment with volume mounts for incremental builds.
# Uses the same production image but optimized for development workflow.
#
# USAGE:
#   Development with Frontend (hot-reload):
#     1. cargo build --release
#     2. docker compose -f docker-compose.dev.yml up
#
#   Development with Monitoring (Grafana, Prometheus, Loki, Tempo):
#     docker compose -f docker-compose.dev.yml --profile monitoring up
#
#   Production Build (nginx-served frontend):
#     docker compose -f docker-compose.dev.yml --profile production up
#
#   GPU Development (NVIDIA):
#     docker compose -f docker-compose.dev.yml --profile gpu-nvidia up
#
#   GPU Development (AMD):
#     docker compose -f docker-compose.dev.yml --profile gpu-amd up
#
# PORTS:
#   - 30303: P2P Discovery
#   - 8545:  JSON-RPC API
#   - 8546:  WebSocket API
#   - 8765:  Controls Panel (Frontend)
#   - 3000:  Grafana (monitoring profile)
#   - 9090:  Prometheus (monitoring profile)
# ==============================================================================

name: quantum-chain-dev

# ==============================================================================
# SHARED CONFIGURATIONS
# ==============================================================================
x-common-env: &common-env
  QC_LOG_LEVEL: debug
  QC_NETWORK: ${QC_NETWORK:-devnet}
  RUST_BACKTRACE: full
  RUST_LOG: "info,qc_17_block_production=debug,qc_02_block_storage=debug,qc_08_consensus=debug,node_runtime=debug"
  OTEL_SDK_DISABLED: "true" # Disable OpenTelemetry when monitoring profile isn't running

# ==============================================================================
# SERVICES
# ==============================================================================
services:
  # ============================================================================
  # CORE: Quantum-Chain Node (Development Mode - uses host binary)
  # ============================================================================
  quantum-chain:
    image: debian:bookworm-slim
    container_name: qc-dev-node
    hostname: quantum-chain
    command: [ "/usr/local/bin/quantum-chain", "--data-dir", "/var/quantum-chain/data", "--config-dir", "/var/quantum-chain/config" ]
    environment:
      <<: *common-env
      QC_DATA_DIR: /var/quantum-chain/data
      QC_P2P_PORT: 30303
      QC_RPC_PORT: 8545
      QC_WS_PORT: 8546
    volumes:
      # Mount pre-built binary from host (fast iteration)
      - ./target/release/node-runtime:/usr/local/bin/quantum-chain:ro
      # Mount config for live editing
      - ./config:/var/quantum-chain/config:ro
      # Persistent data in local folder (visible in project)
      - ./data:/var/quantum-chain/data
    ports:
      - "${QC_P2P_PORT:-30303}:30303/tcp"
      - "${QC_P2P_PORT:-30303}:30303/udp"
      - "${QC_RPC_PORT:-8545}:8545/tcp"
      - "${QC_WS_PORT:-8546}:8546/tcp"
    networks:
      - qc-dev
    # Limit CPU to leave headroom for API responses
    # Mining will use all available CPU, starving the API Gateway
    deploy:
      resources:
        limits:
          cpus: '4.0' # Limit to 4 CPU cores for dev mode
    restart: unless-stopped

  # ============================================================================
  # FRONTEND: Controls Panel (Production Build)
  # ============================================================================
  controls-panel:
    build:
      context: ./controls
      dockerfile: Dockerfile
    container_name: qc-controls-panel
    ports:
      - "${QC_CONTROLS_PORT:-8765}:80"
    networks:
      - qc-dev
    depends_on:
      - quantum-chain
    profiles:
      - production
    restart: unless-stopped

  # ============================================================================
  # FRONTEND: Controls Panel (Development Mode - Hot Reload)
  # ============================================================================
  controls-dev:
    image: node:22-alpine
    container_name: qc-controls-dev
    working_dir: /app
    command: sh -c "npm install 2>/dev/null || npm ci && npm run dev -- --host 0.0.0.0 --port 8765"
    volumes:
      - ./controls:/app
      - /app/node_modules
    ports:
      - "${QC_CONTROLS_PORT:-8765}:8765"
    environment:
      - VITE_API_URL=http://quantum-chain:8545
      - VITE_WS_URL=ws://quantum-chain:8546
      - NODE_ENV=development
    networks:
      - qc-dev
    depends_on:
      - quantum-chain
    restart: unless-stopped

  # ============================================================================
  # GPU: NVIDIA Support (Development Mode - uses host binary)
  # ============================================================================
  quantum-chain-gpu-nvidia:
    image: ubuntu:24.04
    container_name: qc-dev-node-nvidia
    command: [ "/usr/local/bin/quantum-chain", "--data-dir", "/var/quantum-chain/data", "--config-dir", "/var/quantum-chain/config" ]
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu, compute, utility ]
    environment:
      <<: *common-env
      QC_COMPUTE_BACKEND: auto
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    volumes:
      # Mount pre-built binary from host (fast iteration)
      - ./target/release/node-runtime:/usr/local/bin/quantum-chain:ro
      # Mount host OpenCL libs (no container build needed)
      - /usr/lib/libOpenCL.so.1:/usr/lib/x86_64-linux-gnu/libOpenCL.so.1:ro
      - /etc/OpenCL/vendors:/etc/OpenCL/vendors:ro
      # Mount config for live editing
      - ./config:/var/quantum-chain/config:ro
      # Persistent data in local folder
      - ./data:/var/quantum-chain/data
    ports:
      - "${QC_P2P_PORT:-30303}:30303/tcp"
      - "${QC_P2P_PORT:-30303}:30303/udp"
      - "${QC_RPC_PORT:-8545}:8545/tcp"
      - "${QC_WS_PORT:-8546}:8546/tcp"
    networks:
      - qc-dev
    profiles:
      - gpu-nvidia
    restart: unless-stopped

  # ============================================================================
  # GPU: AMD Support
  # ============================================================================
  quantum-chain-gpu-amd:
    extends:
      service: quantum-chain
    container_name: qc-dev-node-amd
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GPU_BACKEND: amd
    devices:
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    group_add:
      - video
      - render
    environment:
      <<: *common-env
      QC_COMPUTE_BACKEND: auto
      AMD_VULKAN_ICD: RADV
      HSA_OVERRIDE_GFX_VERSION: "10.3.0"
    profiles:
      - gpu-amd

  # ============================================================================
  # MONITORING: Event Bus (Redis)
  # ============================================================================
  event-bus:
    image: redis:7-alpine
    container_name: qc-dev-eventbus
    command: redis-server --appendonly yes --maxmemory 256mb
    volumes:
      - qc-eventbus:/data
    networks:
      - qc-dev
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
    profiles:
      - monitoring
    restart: unless-stopped

  # ============================================================================
  # MONITORING: Prometheus (Metrics)
  # ============================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: qc-dev-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./docker/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - qc-prometheus:/prometheus
    ports:
      - "9090:9090"
    networks:
      - qc-dev
    profiles:
      - monitoring
    restart: unless-stopped

  # ============================================================================
  # MONITORING: Loki (Logs)
  # ============================================================================
  loki:
    image: grafana/loki:3.0.0
    container_name: qc-dev-loki
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./docker/monitoring/loki/config.yml:/etc/loki/config.yml:ro
      - qc-loki:/loki
    ports:
      - "3100:3100"
    networks:
      - qc-dev
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:3100/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - monitoring
    restart: unless-stopped

  # ============================================================================
  # MONITORING: Promtail (Log Shipper)
  # ============================================================================
  promtail:
    image: grafana/promtail:3.0.0
    container_name: qc-dev-promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./docker/monitoring/promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - qc-dev
    depends_on:
      - loki
    profiles:
      - monitoring
    restart: unless-stopped

  # ============================================================================
  # MONITORING: Tempo (Distributed Tracing)
  # ============================================================================
  tempo:
    image: grafana/tempo:2.4.0
    container_name: qc-dev-tempo
    command: -config.file=/etc/tempo/config.yml
    volumes:
      - ./docker/monitoring/tempo/config.yml:/etc/tempo/config.yml:ro
      - qc-tempo:/var/tempo
    ports:
      - "3200:3200"
      - "4317:4317"
      - "4318:4318"
    networks:
      - qc-dev
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:3200/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - monitoring
    restart: unless-stopped

  # ============================================================================
  # MONITORING: Grafana (Dashboards)
  # ============================================================================
  grafana:
    image: grafana/grafana:11.0.0
    container_name: qc-dev-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-quantum}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - qc-grafana:/var/lib/grafana
      - ./docker/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      - qc-dev
    depends_on:
      - prometheus
      - loki
      - tempo
    profiles:
      - monitoring
    restart: unless-stopped

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  qc-dev:
    driver: bridge

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  qc-eventbus:
    name: qc-dev-eventbus
  qc-prometheus:
    name: qc-dev-prometheus
  qc-loki:
    name: qc-dev-loki
  qc-tempo:
    name: qc-dev-tempo
  qc-grafana:
    name: qc-dev-grafana

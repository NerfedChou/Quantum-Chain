# ==============================================================================
# Quantum-Chain Development Dockerfile
# ==============================================================================
# Minimal container that runs pre-built binary from host.
# Binary is mounted via docker-compose.dev.yml volume.
#
# This avoids rebuild time during development - just:
#   1. cargo build --release
#   2. docker compose restart
# ==============================================================================

FROM debian:bookworm-slim

# Install runtime dependencies only
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    libssl3 \
    librocksdb7.8 \
    libsnappy1v5 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create non-root user
RUN groupadd -g 1000 quantum \
    && useradd -u 1000 -g quantum -s /sbin/nologin -M quantum

# Create data directories
RUN mkdir -p /var/quantum-chain/data \
    && mkdir -p /var/quantum-chain/config \
    && mkdir -p /var/quantum-chain/logs \
    && chown -R quantum:quantum /var/quantum-chain \
    && chmod -R 750 /var/quantum-chain

# The binary will be mounted from host via volume
# Placeholder so container can start (will be overwritten by volume mount)
RUN touch /usr/local/bin/quantum-chain && chmod 755 /usr/local/bin/quantum-chain

USER quantum
WORKDIR /var/quantum-chain

EXPOSE 30303/tcp 30303/udp 8545/tcp 8546/tcp 9090/tcp

ENV QC_DATA_DIR=/var/quantum-chain/data
ENV QC_CONFIG_DIR=/var/quantum-chain/config
ENV QC_LOG_LEVEL=debug
ENV RUST_BACKTRACE=1

ENTRYPOINT ["/usr/local/bin/quantum-chain"]
CMD ["--data-dir", "/var/quantum-chain/data", "--config-dir", "/var/quantum-chain/config"]
